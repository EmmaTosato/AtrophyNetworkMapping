digraph DL_Analysis_Workflow {
    // Graph settings
    rankdir=LR;
    node [shape=box, style=rounded];
    
    // Color scheme
    node [fontname="Arial"];
    edge [fontname="Arial", fontsize=10];
    
    // === ENTRY POINTS (RED) ===
    subgraph cluster_entry {
        label="Entry Points";
        style=filled;
        color=lightgrey;
        
        run_train_py [label="run_train.py\n(loop over seeds)", fillcolor="#ff6b6b", style="filled,rounded"];
        hyper_tuning_py [label="hyper_tuning.py\n(grid search)", fillcolor="#ff6b6b", style="filled,rounded"];
        run_test_tuning_py [label="run_test_tuning.py\n(test best configs)", fillcolor="#ff6b6b", style="filled,rounded"];
        run_test_py [label="run_test.py\n(batch testing)", fillcolor="#ff6b6b", style="filled,rounded"];
    }
    
    // === CORE PIPELINE (BLUE) ===
    subgraph cluster_core {
        label="Core Pipeline (run.py)";
        style=filled;
        color=lightblue;
        
        set_seed [label="set_seed(seed)", fillcolor="#4ecdc4", style="filled,rounded"];
        main_worker [label="main_worker(params)\n[CENTRAL HUB]", fillcolor="#1a535c", style="filled,rounded", fontcolor=white];
        run_epochs [label="run_epochs(...)\n(train + validate)", fillcolor="#4ecdc4", style="filled,rounded"];
    }
    
    // === TRAINING FUNCTIONS (GREEN) ===
    subgraph cluster_train {
        label="Training Functions (train.py)";
        style=filled;
        color=lightgreen;
        
        train_fn [label="train(model, loader)", fillcolor="#95e1d3", style="filled,rounded"];
        validate_fn [label="validate(model, loader)", fillcolor="#95e1d3", style="filled,rounded"];
        plot_losses [label="plot_losses(...)", fillcolor="#95e1d3", style="filled,rounded"];
    }
    
    // === TESTING FUNCTIONS (YELLOW) ===
    subgraph cluster_test {
        label="Testing Functions (test.py)";
        style=filled;
        color=lightyellow;
        
        evaluate_fn [label="evaluate(model, loader)", fillcolor="#ffeaa7", style="filled,rounded"];
        compute_metrics [label="compute_metrics(y_true, y_pred)", fillcolor="#ffeaa7", style="filled,rounded"];
        plot_confusion [label="plot_confusion_matrix(...)", fillcolor="#ffeaa7", style="filled,rounded"];
    }
    
    // === DATA LOADERS (PURPLE) ===
    subgraph cluster_data {
        label="Data Loading (datasets.py)";
        style=filled;
        color=plum;
        
        FCDataset [label="FCDataset\n(standard)", fillcolor="#dfe6e9", style="filled,rounded"];
        AugmentedFCDataset [label="AugmentedFCDataset\n(augmented)", fillcolor="#dfe6e9", style="filled,rounded"];
    }
    
    // === MODELS (ORANGE) ===
    subgraph cluster_models {
        label="Models (models.py)";
        style=filled;
        color=peachpuff;
        
        ResNet3D [label="ResNet3D", fillcolor="#fdcb6e", style="filled,rounded"];
        DenseNet3D [label="DenseNet3D", fillcolor="#fdcb6e", style="filled,rounded"];
        VGG16_3D [label="VGG16_3D", fillcolor="#fdcb6e", style="filled,rounded"];
    }
    
    // === UTILITIES (GRAY) ===
    subgraph cluster_utils {
        label="Utilities (cnn_utils.py)";
        style=filled;
        color=lightgray;
        
        resolve_split [label="resolve_split_csv_path(...)", fillcolor="#b2bec3", style="filled,rounded"];
        create_train_summary [label="create_training_summary(...)", fillcolor="#b2bec3", style="filled,rounded"];
        create_test_summary [label="create_testing_summary(...)", fillcolor="#b2bec3", style="filled,rounded"];
        create_tuning_summary [label="create_tuning_summary(...)", fillcolor="#b2bec3", style="filled,rounded"];
        is_valid_combo [label="is_valid_combo(params)", fillcolor="#b2bec3", style="filled,rounded"];
    }
    
    // === EXTERNAL LIBRARIES (DIAMOND) ===
    sklearn_fold [label="StratifiedKFold", shape=diamond, fillcolor="#74b9ff", style=filled];
    torch_save [label="torch.save()", shape=diamond, fillcolor="#74b9ff", style=filled];
    torch_load [label="torch.load()", shape=diamond, fillcolor="#74b9ff", style=filled];
    subprocess_run [label="subprocess.run()", shape=diamond, fillcolor="#74b9ff", style=filled];
    itertools_product [label="itertools.product()", shape=diamond, fillcolor="#74b9ff", style=filled];
    
    
    // =============================================
    // === CALL RELATIONSHIPS ===
    // =============================================
    
    // Entry points → main_worker
    run_train_py -> subprocess_run [label="calls"];
    subprocess_run -> main_worker [label="launches run.py"];
    
    hyper_tuning_py -> is_valid_combo [label="validates combos"];
    hyper_tuning_py -> itertools_product [label="generates grid"];
    hyper_tuning_py -> main_worker [label="calls directly"];
    hyper_tuning_py -> create_tuning_summary [label="saves results"];
    
    run_test_tuning_py -> subprocess_run;
    run_test_py -> subprocess_run;
    
    // main_worker → core functions
    main_worker -> set_seed [label="1. init"];
    main_worker -> resolve_split [label="2. load split"];
    main_worker -> sklearn_fold [label="3. CV setup"];
    
    // main_worker → data loaders
    main_worker -> FCDataset [label="test set"];
    main_worker -> AugmentedFCDataset [label="train set"];
    
    // main_worker → models
    main_worker -> ResNet3D [label="if model_type='resnet'"];
    main_worker -> DenseNet3D [label="if model_type='densenet'"];
    main_worker -> VGG16_3D [label="if model_type='vgg16'"];
    
    // main_worker → run_epochs (training mode)
    main_worker -> run_epochs [label="FOR EACH FOLD", style=bold, color=blue];
    
    // run_epochs → training functions
    run_epochs -> train_fn [label="FOR EACH EPOCH", style=bold];
    run_epochs -> validate_fn [label="after train"];
    run_epochs -> torch_save [label="save checkpoint"];
    run_epochs -> plot_losses [label="optional"];
    
    // main_worker → testing functions (evaluation mode)
    main_worker -> torch_load [label="load checkpoint"];
    main_worker -> evaluate_fn [label="on test set"];
    evaluate_fn -> compute_metrics [label="compute"];
    compute_metrics -> plot_confusion [label="optional"];
    
    // main_worker → summaries
    main_worker -> create_train_summary [label="if crossval_flag"];
    main_worker -> create_test_summary [label="if evaluation_flag"];
    
    
    // =============================================
    // === LEGEND ===
    // =============================================
    subgraph cluster_legend {
        label="Legend";
        style=filled;
        color=white;
        
        legend_entry [label="Entry Points", fillcolor="#ff6b6b", style="filled,rounded"];
        legend_core [label="Core Logic", fillcolor="#1a535c", style="filled,rounded", fontcolor=white];
        legend_train [label="Training", fillcolor="#95e1d3", style="filled,rounded"];
        legend_test [label="Testing", fillcolor="#ffeaa7", style="filled,rounded"];
        legend_data [label="Data", fillcolor="#dfe6e9", style="filled,rounded"];
        legend_models [label="Models", fillcolor="#fdcb6e", style="filled,rounded"];
        legend_utils [label="Utils", fillcolor="#b2bec3", style="filled,rounded"];
        legend_external [label="External", shape=diamond, fillcolor="#74b9ff", style=filled];
    }
}
